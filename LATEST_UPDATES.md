# 最新更新说明

## ✅ 已完成的功能

### 1. 目录树优化
- ✅ 增加目录树宽度到 350px
- ✅ 支持手动调整宽度（可拖拽）
- ✅ 优化 CSS 样式，确保目录名完整显示
- ✅ 刷新页面后保持选中状态（localStorage）
- ✅ 保持当前视图状态（文件管理/用户管理/提案管理）

### 2. 个人信息按钮修复
- ✅ 修复下拉菜单点击事件
- ✅ 合并 message 导入
- ✅ 个人信息按钮现在可以正常点击

### 3. 登录验证码
- ✅ 创建自定义验证码组件
- ✅ 支持点击刷新验证码
- ✅ 随机字符和颜色
- ✅ 干扰线和干扰点
- ✅ 登录时验证码校验

### 4. 注册审核机制
- ✅ 注册时显示审核提示
- ✅ 注册验证码
- ✅ 用户状态字段（pending/active/inactive）
- ✅ 登录时检查用户状态
- ✅ 管理员审核功能
  - 审核通过
  - 拒绝申请
- ✅ 用户列表显示状态标签

## 📁 新增文件

```
proposal-system-frontend/src/
└── components/
    └── Captcha.js                 # 验证码组件

proposal-system-backend/database/migrations/
└── 2025_10_14_155645_add_status_to_users_table.php  # 用户状态字段迁移
```

## 🔄 修改的文件

### 前端
1. **src/App.js**
   - 添加状态持久化（localStorage）
   - 修复 message 导入
   - 保存选中目录和当前视图

2. **src/components/Login.js**
   - 添加验证码输入
   - 添加验证码校验
   - 添加注册审核提示

3. **src/components/UserManagement.js**
   - 添加用户状态显示
   - 添加审核通过/拒绝按钮
   - 根据状态显示不同操作

4. **src/components/DirectoryTree.css**
   - 优化样式，确保目录名完整显示

### 后端
1. **app/Http/Controllers/Api/AuthController.php**
   - 添加用户状态检查
   - 待审核用户不能登录
   - 已禁用用户不能登录

2. **app/Http/Controllers/Api/UserController.php**
   - 添加 approve 方法（审核通过）
   - 添加 reject 方法（拒绝申请）

3. **routes/api.php**
   - 添加审核路由

4. **database/migrations/..._add_status_to_users_table.php**
   - 添加 status 字段

## 🎨 界面效果

### 登录页面
```
┌─────────────────────────────┐
│ 提案系统                    │
├─────────────────────────────┤
│ [登录] [注册]               │
│                             │
│ 邮箱：                      │
│ [📧 user@example.com]       │
│                             │
│ 密码：                      │
│ [🔒 ********]               │
│                             │
│ 验证码：                    │
│ [🛡️ ____] [Abc4] ← 点击刷新│
│                             │
│ [登录]                      │
└─────────────────────────────┘
```

### 注册页面
```
┌─────────────────────────────┐
│ 提案系统                    │
├─────────────────────────────┤
│ [登录] [注册]               │
│                             │
│ ℹ️ 注册须知                 │
│ 注册后需要等待管理员审核    │
│                             │
│ 姓名：[👤 张三]             │
│ 邮箱：[📧 user@example.com] │
│ 密码：[🔒 ********]         │
│ 确认：[🔒 ********]         │
│ 验证码：[🛡️ ____] [Xy9Z]   │
│                             │
│ [注册]                      │
└─────────────────────────────┘
```

### 用户管理页面
```
┌──────────────────────────────────────────────────┐
│ ID │ 姓名 │ 邮箱 │ 角色 │ 状态 │ 操作          │
├────┼──────┼──────┼──────┼──────┼───────────────┤
│ 1  │ 张三 │ ... │ 管理员│ 正常 │ [编辑][重置]  │
│ 2  │ 李四 │ ... │ 用户  │待审核│ [通过][拒绝]  │
│ 3  │ 王五 │ ... │ 用户  │已禁用│ [删除]        │
└────┴──────┴──────┴──────┴──────┴───────────────┘
```

## 🔐 用户状态说明

### pending（待审核）
- 新注册用户的默认状态
- 不能登录
- 管理员可以审核通过或拒绝

### active（正常）
- 审核通过的用户
- 可以正常登录使用
- 管理员可以编辑和重置密码

### inactive（已禁用）
- 被拒绝或禁用的用户
- 不能登录
- 管理员可以删除

## 🚀 使用流程

### 新用户注册
1. 填写注册信息
2. 输入验证码
3. 提交注册
4. 等待管理员审核

### 管理员审核
1. 登录管理员账户
2. 进入用户管理
3. 查看待审核用户
4. 点击"通过"或"拒绝"

### 用户登录
1. 输入邮箱和密码
2. 输入验证码
3. 点击登录
4. 如果状态为待审核或已禁用，会显示相应提示

## 📝 数据库迁移

运行迁移添加用户状态字段：

```bash
cd proposal-system-backend
php artisan migrate
```

## 🔧 API 端点

### 新增接口

```
POST /api/users/{id}/approve    # 审核通过
POST /api/users/{id}/reject     # 拒绝申请
```

### 修改接口

```
POST /api/login                 # 添加状态检查
POST /api/register              # 默认状态为 pending
```

## 💡 注意事项

1. **首次使用**
   - 需要运行数据库迁移
   - 第一个注册的用户建议手动设置为 active 状态

2. **验证码**
   - 不区分大小写
   - 点击验证码图片可刷新
   - 每次提交后自动刷新

3. **状态持久化**
   - 选中的目录会保存在 localStorage
   - 刷新页面后自动恢复
   - 切换视图状态也会保存

4. **审核流程**
   - 只有管理员可以审核用户
   - 待审核用户不能登录
   - 审核通过后用户才能使用系统

## 🐛 故障排除

### 问题1：验证码不显示

**解决方案：**
- 检查浏览器控制台错误
- 确认 Captcha 组件正确导入
- 清除浏览器缓存

### 问题2：状态不保存

**解决方案：**
```javascript
// 检查 localStorage
console.log(localStorage.getItem('selectedDirectory'));
console.log(localStorage.getItem('currentView'));

// 清除并重新选择
localStorage.removeItem('selectedDirectory');
localStorage.removeItem('currentView');
```

### 问题3：审核按钮不显示

**解决方案：**
- 确认用户状态为 pending
- 检查后端迁移是否运行
- 刷新用户列表

### 问题4：登录提示待审核

**解决方案：**
```bash
# 手动设置用户为 active
php artisan tinker

$user = User::find(1);
$user->status = 'active';
$user->save();
```

## 📚 相关文档

- [API 文档](./API_DOCUMENTATION.md)
- [新功能说明](./NEW_FEATURES.md)
- [故障排除](./TROUBLESHOOTING.md)
- [快速开始](./QUICK_START.md)

---

**更新时间：** 2025-10-14  
**版本：** v1.2.0
