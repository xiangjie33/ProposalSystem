# åŠŸèƒ½è¯´æ˜ - ç›®å½•æƒé™ç»§æ‰¿

## ğŸ¯ é—®é¢˜æè¿°

å½“ç”¨æˆ·è¢«æˆæƒè®¿é—®å­ç›®å½•æ—¶ï¼Œæ— æ³•çœ‹åˆ°çˆ¶ç›®å½•ï¼Œå¯¼è‡´æ— æ³•å¯¼èˆªåˆ°å­ç›®å½•ã€‚

**ç¤ºä¾‹ï¼š**
```
admin/
  â””â”€â”€ xiangjie2/  â† ç”¨æˆ·è¢«æˆæƒè®¿é—®è¿™ä¸ª

å®é™…æƒ…å†µï¼š
- ç”¨æˆ·çœ‹ä¸åˆ° admin ç›®å½•
- å› æ­¤ä¹Ÿæ— æ³•è®¿é—® xiangjie2 ç›®å½•
```

## âœ… è§£å†³æ–¹æ¡ˆ

å®ç°"å‘ä¸Šå¯è§"çš„æƒé™ç»§æ‰¿æœºåˆ¶ï¼š
- å¦‚æœç”¨æˆ·æœ‰å­ç›®å½•çš„è®¿é—®æƒé™
- åˆ™è‡ªåŠ¨å¯ä»¥çœ‹åˆ°ï¼ˆä½†ä¸ä¸€å®šèƒ½æ“ä½œï¼‰æ‰€æœ‰çˆ¶ç›®å½•
- è¿™æ ·ç”¨æˆ·å¯ä»¥å¯¼èˆªåˆ°è¢«æˆæƒçš„å­ç›®å½•

## ğŸ”§ å®ç°é€»è¾‘

### 1. ç›®å½•æ ‘æƒé™è¿‡æ»¤

**åŸç†ï¼š**
1. è·å–ç”¨æˆ·è¢«æˆæƒçš„æ‰€æœ‰ç›®å½•ID
2. æŸ¥æ‰¾è¿™äº›ç›®å½•çš„æ‰€æœ‰ç¥–å…ˆç›®å½•ID
3. åˆå¹¶æˆæƒç›®å½•å’Œç¥–å…ˆç›®å½•
4. åªæ˜¾ç¤ºè¿™äº›ç›®å½•

**ä»£ç å®ç°ï¼š**

```php
public function tree()
{
    $user = auth()->user();
    
    // ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰ç›®å½•
    if ($user->isAdmin()) {
        return Directory::with(['children.children', 'files'])
            ->whereNull('parent_id')
            ->get();
    }
    
    // è·å–ç”¨æˆ·è¢«æˆæƒçš„ç›®å½•ID
    $authorizedDirectoryIds = $user->directories()->pluck('directories.id')->toArray();
    
    // è·å–æ‰€æœ‰ç¥–å…ˆç›®å½•ID
    $ancestorIds = $this->getAncestorDirectoryIds($authorizedDirectoryIds);
    
    // åˆå¹¶å¯è§ç›®å½•
    $visibleDirectoryIds = array_unique(array_merge($authorizedDirectoryIds, $ancestorIds));
    
    // è¿”å›è¿‡æ»¤åçš„ç›®å½•æ ‘
    return Directory::with(['children' => function($query) use ($visibleDirectoryIds) {
            $query->whereIn('id', $visibleDirectoryIds)
                  ->orWhere('is_public', true);
        }])
        ->whereNull('parent_id')
        ->where(function($q) use ($visibleDirectoryIds) {
            $q->whereIn('id', $visibleDirectoryIds)
              ->orWhere('is_public', true);
        })
        ->get();
}

/**
 * é€’å½’è·å–ç¥–å…ˆç›®å½•ID
 */
private function getAncestorDirectoryIds($directoryIds)
{
    $ancestorIds = [];
    
    foreach ($directoryIds as $dirId) {
        $directory = Directory::find($dirId);
        if ($directory) {
            $current = $directory;
            // å‘ä¸Šéå†åˆ°æ ¹ç›®å½•
            while ($current->parent_id) {
                if (!in_array($current->parent_id, $ancestorIds)) {
                    $ancestorIds[] = $current->parent_id;
                }
                $current = Directory::find($current->parent_id);
                if (!$current) break;
            }
        }
    }
    
    return $ancestorIds;
}
```

### 2. æƒé™çº§åˆ«

**å¯è§æ€§ vs æ“ä½œæƒé™ï¼š**

| ç›®å½• | è¢«æˆæƒ | å¯è§ | å¯æ“ä½œ |
|------|--------|------|--------|
| æ ¹ç›®å½• | âŒ | âœ… (å› ä¸ºå­ç›®å½•è¢«æˆæƒ) | âŒ |
| å­ç›®å½• | âœ… | âœ… | âœ… |
| å­™ç›®å½• | âŒ | âŒ | âŒ |

**è¯´æ˜ï¼š**
- **å¯è§**ï¼šå¯ä»¥åœ¨ç›®å½•æ ‘ä¸­çœ‹åˆ°
- **å¯æ“ä½œ**ï¼šå¯ä»¥æŸ¥çœ‹æ–‡ä»¶ã€ä¸Šä¼ ã€ä¸‹è½½ç­‰

## ğŸ“‹ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šé¡¹ç›®å­ç›®å½•æˆæƒ

**éœ€æ±‚ï¼š**
```
é¡¹ç›®A/
  â”œâ”€â”€ æ–‡æ¡£/
  â”œâ”€â”€ ä»£ç /  â† åªæˆæƒè¿™ä¸ªç»™å¼€å‘äººå‘˜
  â””â”€â”€ æµ‹è¯•/
```

**æ•ˆæœï¼š**
- å¼€å‘äººå‘˜å¯ä»¥çœ‹åˆ°"é¡¹ç›®A"ï¼ˆçˆ¶ç›®å½•ï¼‰
- å¼€å‘äººå‘˜å¯ä»¥çœ‹åˆ°"ä»£ç "ï¼ˆæˆæƒç›®å½•ï¼‰
- å¼€å‘äººå‘˜çœ‹ä¸åˆ°"æ–‡æ¡£"å’Œ"æµ‹è¯•"ï¼ˆæœªæˆæƒçš„å…„å¼Ÿç›®å½•ï¼‰

### åœºæ™¯ 2ï¼šæ·±å±‚ç›®å½•æˆæƒ

**éœ€æ±‚ï¼š**
```
å…¬å¸/
  â””â”€â”€ éƒ¨é—¨A/
      â””â”€â”€ é¡¹ç›®1/
          â””â”€â”€ æ–‡æ¡£/  â† åªæˆæƒè¿™ä¸ª
```

**æ•ˆæœï¼š**
- ç”¨æˆ·å¯ä»¥çœ‹åˆ°ï¼šå…¬å¸ â†’ éƒ¨é—¨A â†’ é¡¹ç›®1 â†’ æ–‡æ¡£
- ç”¨æˆ·åªèƒ½æ“ä½œ"æ–‡æ¡£"ç›®å½•
- å…¶ä»–ç›®å½•åªæ˜¯å¯¼èˆªè·¯å¾„

### åœºæ™¯ 3ï¼šå¤šä¸ªå­ç›®å½•æˆæƒ

**éœ€æ±‚ï¼š**
```
admin/
  â”œâ”€â”€ sanguo/     â† æˆæƒ
  â”œâ”€â”€ xiangjie2/  â† æˆæƒ
  â””â”€â”€ xiangjie33/ â† æˆæƒ
```

**æ•ˆæœï¼š**
- ç”¨æˆ·å¯ä»¥çœ‹åˆ°"admin"ï¼ˆçˆ¶ç›®å½•ï¼‰
- ç”¨æˆ·å¯ä»¥çœ‹åˆ°å¹¶æ“ä½œæ‰€æœ‰ä¸‰ä¸ªå­ç›®å½•

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯• 1ï¼šå­ç›®å½•æˆæƒ

```bash
# 1. åˆ›å»ºç›®å½•ç»“æ„
admin/
  â””â”€â”€ xiangjie2/

# 2. åªæˆæƒ xiangjie2 ç»™ç”¨æˆ·

# 3. ç”¨æˆ·ç™»å½•ååº”è¯¥çœ‹åˆ°ï¼š
admin/  â† å¯è§ä½†ä¸å¯æ“ä½œ
  â””â”€â”€ xiangjie2/  â† å¯è§ä¸”å¯æ“ä½œ
```

### æµ‹è¯• 2ï¼šå¤šçº§ç›®å½•

```bash
# 1. åˆ›å»ºæ·±å±‚ç»“æ„
A/
  â””â”€â”€ B/
      â””â”€â”€ C/
          â””â”€â”€ D/  â† åªæˆæƒè¿™ä¸ª

# 2. ç”¨æˆ·åº”è¯¥çœ‹åˆ°å®Œæ•´è·¯å¾„ï¼š
A/ â†’ B/ â†’ C/ â†’ D/

# 3. ä½†åªèƒ½æ“ä½œ D ç›®å½•
```

### æµ‹è¯• 3ï¼šå…„å¼Ÿç›®å½•éš”ç¦»

```bash
# 1. åˆ›å»ºç»“æ„
parent/
  â”œâ”€â”€ child1/  â† æˆæƒ
  â”œâ”€â”€ child2/  â† ä¸æˆæƒ
  â””â”€â”€ child3/  â† æˆæƒ

# 2. ç”¨æˆ·åº”è¯¥çœ‹åˆ°ï¼š
parent/
  â”œâ”€â”€ child1/  â† å¯è§
  â””â”€â”€ child3/  â† å¯è§

# 3. child2 ä¸å¯è§
```

## ğŸ’¡ æƒé™æ£€æŸ¥é€»è¾‘

### æŸ¥çœ‹ç›®å½•å†…å®¹

```php
// ç”¨æˆ·å¯ä»¥æŸ¥çœ‹ç›®å½•å†…å®¹çš„æ¡ä»¶ï¼š
1. ç”¨æˆ·æ˜¯ç®¡ç†å‘˜
2. ç›®å½•æ˜¯å…¬å¼€çš„
3. ç”¨æˆ·è¢«æ˜ç¡®æˆæƒè¯¥ç›®å½•
4. ç”¨æˆ·è¢«æˆæƒè¯¥ç›®å½•çš„ä»»ä½•å­ç›®å½•ï¼ˆå¯ä»¥çœ‹åˆ°ä½†ä¸èƒ½æ“ä½œï¼‰
```

### æ“ä½œç›®å½•

```php
// ç”¨æˆ·å¯ä»¥æ“ä½œç›®å½•ï¼ˆä¸Šä¼ ã€ä¸‹è½½ç­‰ï¼‰çš„æ¡ä»¶ï¼š
1. ç”¨æˆ·æ˜¯ç®¡ç†å‘˜
2. ç›®å½•æ˜¯å…¬å¼€çš„ AND ç”¨æˆ·æœ‰ç›¸åº”æƒé™
3. ç”¨æˆ·è¢«æ˜ç¡®æˆæƒè¯¥ç›®å½•
```

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. æ€§èƒ½è€ƒè™‘

**é—®é¢˜ï¼š**
- é€’å½’æŸ¥è¯¢ç¥–å…ˆç›®å½•å¯èƒ½å½±å“æ€§èƒ½

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
```php
// æ–¹æ¡ˆ 1ï¼šç¼“å­˜ç¥–å…ˆç›®å½•
Cache::remember("user_{$userId}_ancestor_dirs", 3600, function() {
    return $this->getAncestorDirectoryIds($authorizedIds);
});

// æ–¹æ¡ˆ 2ï¼šä½¿ç”¨é—­åŒ…è¡¨ï¼ˆClosure Tableï¼‰
// åœ¨æ•°æ®åº“ä¸­é¢„å…ˆå­˜å‚¨æ‰€æœ‰ç¥–å…ˆå…³ç³»

// æ–¹æ¡ˆ 3ï¼šä½¿ç”¨è·¯å¾„å­—æ®µ
// åœ¨ directories è¡¨æ·»åŠ  path å­—æ®µï¼Œå­˜å‚¨å®Œæ•´è·¯å¾„
```

### 2. æƒé™æ›´æ–°

**é—®é¢˜ï¼š**
- æˆæƒå˜æ›´åï¼Œç¼“å­˜å¯èƒ½ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆï¼š**
```php
// åœ¨æ›´æ–°ç”¨æˆ·ç›®å½•æƒé™æ—¶æ¸…é™¤ç¼“å­˜
public function update(Request $request, User $user)
{
    // ... æ›´æ–°é€»è¾‘
    
    if ($request->has('directories')) {
        $user->directories()->sync($request->directories);
        
        // æ¸…é™¤ç¼“å­˜
        Cache::forget("user_{$user->id}_ancestor_dirs");
        Cache::forget("user_{$user->id}_visible_dirs");
    }
}
```

### 3. å…¬å¼€ç›®å½•

**è§„åˆ™ï¼š**
- å…¬å¼€ç›®å½•å§‹ç»ˆå¯è§
- å…¬å¼€ç›®å½•çš„å­ç›®å½•ä¸è‡ªåŠ¨å…¬å¼€
- éœ€è¦å•ç‹¬è®¾ç½®

### 4. æ–‡ä»¶è®¿é—®

**é‡è¦ï¼š**
- èƒ½çœ‹åˆ°ç›®å½• â‰  èƒ½è®¿é—®ç›®å½•ä¸­çš„æ–‡ä»¶
- æ–‡ä»¶è®¿é—®éœ€è¦æ£€æŸ¥ç›®å½•æ˜¯å¦è¢«æ˜ç¡®æˆæƒ

```php
// æ–‡ä»¶ä¸‹è½½æƒé™æ£€æŸ¥
public function download(File $file)
{
    $user = auth()->user();
    $directory = $file->directory;
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹è½½æƒé™
    if (!$user->hasPermission('download-file')) {
        return response()->json(['message' => 'æ— ä¸‹è½½æƒé™'], 403);
    }
    
    // æ£€æŸ¥ç›®å½•æƒé™ï¼ˆå¿…é¡»æ˜ç¡®æˆæƒï¼Œä¸èƒ½åªæ˜¯å¯è§ï¼‰
    if (!$user->isAdmin() && 
        !$directory->is_public && 
        !$user->directories->contains($directory->id)) {
        return response()->json(['message' => 'æ— æƒè®¿é—®æ­¤ç›®å½•çš„æ–‡ä»¶'], 403);
    }
    
    return Storage::download($file->path);
}
```

## ğŸ“Š æƒé™çŸ©é˜µ

| åœºæ™¯ | ç›®å½•å¯è§ | æ–‡ä»¶å¯è§ | å¯ä¸Šä¼  | å¯ä¸‹è½½ | å¯åˆ é™¤ |
|------|---------|---------|--------|--------|--------|
| ç®¡ç†å‘˜ | âœ… | âœ… | âœ… | âœ… | âœ… |
| å…¬å¼€ç›®å½• | âœ… | âœ… | âŒ | âœ…* | âŒ |
| æ˜ç¡®æˆæƒ | âœ… | âœ… | âœ…* | âœ…* | âœ…* |
| å­ç›®å½•æˆæƒï¼ˆçˆ¶ç›®å½•ï¼‰ | âœ… | âŒ | âŒ | âŒ | âŒ |
| æœªæˆæƒ | âŒ | âŒ | âŒ | âŒ | âŒ |

*éœ€è¦ç›¸åº”çš„æƒé™ï¼ˆupload-file, download-fileç­‰ï¼‰

## âœ… åŠŸèƒ½æ¸…å•

### å·²å®ç°

- âœ… å­ç›®å½•æˆæƒæ—¶çˆ¶ç›®å½•å¯è§
- âœ… é€’å½’æŸ¥æ‰¾ç¥–å…ˆç›®å½•
- âœ… ç›®å½•æ ‘æ­£ç¡®è¿‡æ»¤
- âœ… å…„å¼Ÿç›®å½•éš”ç¦»
- âœ… å…¬å¼€ç›®å½•æ”¯æŒ

### å¾…ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

- â³ æ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å­˜ï¼‰
- â³ ä½¿ç”¨é—­åŒ…è¡¨ä¼˜åŒ–æŸ¥è¯¢
- â³ æ·»åŠ è·¯å¾„å­—æ®µ
- â³ æ‰¹é‡æƒé™æ£€æŸ¥
- â³ æƒé™é¢„åŠ è½½

## ğŸ”„ å‡çº§å»ºè®®

### çŸ­æœŸä¼˜åŒ–

```php
// 1. æ·»åŠ ç¼“å­˜
public function tree()
{
    $user = auth()->user();
    $cacheKey = "user_{$user->id}_directory_tree";
    
    return Cache::remember($cacheKey, 3600, function() use ($user) {
        // åŸæœ‰é€»è¾‘
    });
}

// 2. æ¸…é™¤ç¼“å­˜
Event::listen(DirectoryPermissionUpdated::class, function($event) {
    Cache::forget("user_{$event->userId}_directory_tree");
});
```

### é•¿æœŸä¼˜åŒ–

```sql
-- æ·»åŠ é—­åŒ…è¡¨
CREATE TABLE directory_paths (
    ancestor_id BIGINT,
    descendant_id BIGINT,
    depth INT,
    PRIMARY KEY (ancestor_id, descendant_id)
);

-- æŸ¥è¯¢å˜å¾—éå¸¸ç®€å•
SELECT DISTINCT ancestor_id 
FROM directory_paths 
WHERE descendant_id IN (æˆæƒçš„ç›®å½•IDs);
```

---

**åŠŸèƒ½å®Œæˆæ—¥æœŸ**ï¼š2025-10-15  
**ç‰ˆæœ¬**ï¼š1.3.0  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ
